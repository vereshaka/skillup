<source>
    @type tail
    path /var/log/containers/microfrontend-hfhs-*.log
    pos_file /tmp/microfrontend-hfhs.log.pos
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    tag hfhs.*
    format json
</source>

<source>
    @type tail
    path /var/log/containers/microfrontend-product-move-*.log
    pos_file /tmp/microfrontend-pm.log.pos
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    tag hfhs.*
    format json
</source>

<source>
    @type tail
    path /var/log/containers/microfrontend-product-details-*.log
    pos_file /tmp/microfrontend-pd.log.pos
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    tag hfhs.*
    format json
</source>

<source>
    @type tail
    path /var/log/containers/microfrontend-search-product-*.log
    pos_file /tmp/microfrontend-sp.log.pos
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    tag hfhs.*
    format json
</source>

<filter hfhs.**>
    @type parser
    key_name log
    <parse>
        @type multi_format
        <pattern>
            format regexp
            expression /^\[(?<datetime>\d+\-\d+\-\d+T\d+\:\d+\:\d+\.\d+)\] \[(?<loglevel>\w+)\] (?<process>\w+) \- (?<esb-status>([Ss]tart|[Ff]inish|[Ee]xecuting))\s(esb|ESB) method (?<method-name>\S+\(\S*\)) with request:(?<tail>.*)/
        </pattern>
        <pattern>
            format regexp
            expression /^\[(?<datetime>\d+\-\d+\-\d+T\d+\:\d+\:\d+\.\d+)\] \[(?<loglevel>\w+)\] (?<process>\w+) \- (?<tail>.*)/
        </pattern>
        <pattern>
            format none
        </pattern>
    </parse>
    reserve_data true
</filter>

<match hfhs.**>
    @type rewrite_tag_filter
    <rule>
        key     tail
        pattern /.*(GET \/package\.json HTTP).*(kube-probe).*/
        tag     useless
    </rule>
    <rule>
        key     tail
        pattern /.*(GET \/package\.json HTTP).*(kube-probe).*/
        tag     logstore
        invert  true
    </rule>
</match>

<match logstore>
    @type elasticsearch
    host es.k8s.sytoss.intra
    port 80
    logstash_format true
    logstash_prefix hfhs-fluentd
    flush_interval 10s
</match>

<match useless>
    @type null
</match>