/*
Jenkinsfile for automation testing

The tests performs every workday at 02:00
*/

pipeline{
    agent{
        node{
            label 'cypress'
        }
    }
    triggers {
        cron 'H 2 * * 1-5'
    }
    stages{
        stage('Clone repo'){
            steps{
                deleteDir()
                checkout([$class: 'GitSCM', branches: [[name: '*/develop']], 
                          doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], 
                          userRemoteConfigs: [[credentialsId: '8c90ce01-4736-4b5a-8661-ab6299330151', url: 'https://tasktrack.telekom.at/bitbucket/scm/ccf/microfrontend-hfhs-common.git']]])
            }
        }
        stage('Install deps'){
            steps{
                nodejs('node10.16.3'){
                    dir('itest/'){
                        sh 'npm i'
                    }
                }
            }
        }
        stage('Perform tests'){
            steps{
                nodejs('node10.16.3'){
                    dir('itest/'){
                        sh 'npm run clean'
                        sh 'npm run test:run -- --browser chromium'
                        sh 'npm run cucumber:reporter'
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'cypress/videos/*.mp4', onlyIfSuccessful: true
                    }
                }
            }
        }
    }
    post{
        always{
            nodejs('node10.16.3'){
                dir('itest/cypress/'){
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'videos/*.mp4', onlyIfSuccessful: false
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'videos/**/*.mp4', onlyIfSuccessful: false
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'screenshots/*.png', onlyIfSuccessful: false
                    archiveArtifacts allowEmptyArchive: true, artifacts: 'screenshots/**/*.png', onlyIfSuccessful: false
                }
            }
            publishHTML([allowMissing: true, alwaysLinkToLastBuild: true,
                         escapeUnderscores: false, includes: '**/*.html,**/*.json',
                         keepAll: true, reportDir: 'itest/cypress/reports',
                         reportFiles: 'hfhs.cucumber.html', reportName: 'Cypress Test Result', reportTitles: ''])
        }
        failure {
            emailext to: 'grp.hfhs@sytoss.com',
                     subject: "Jenkins Pipeline '${JOB_NAME}' (${BUILD_NUMBER}) failed",
                     body: "Please go to ${BUILD_URL} and verify the build",
                     attachLog: true
        }
    }
}